{% extends "layout.html" %}
{% block title %}UWI MAP{% endblock %}
{% block page %}UWI MAP{% endblock %}

{% block content %}
    {% if is_authenticated %}
        <p class="center-align">Welcome {{ current_user.username }}</p>
    {% endif %}
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const toggleBtn = document.getElementById('toggle-button');
    const filterPanel = document.getElementById('filter-panel');
    const closeArrow = document.getElementById('close-arrow');

    toggleBtn.addEventListener('click', () => {
      filterPanel.classList.add('open');
    });

    closeArrow.addEventListener('click', () => {
      filterPanel.classList.remove('open');
    });

    const checkboxes = document.querySelectorAll('.faculty-checkbox');

    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', async (e) => {
        const targetId = e.target.getAttribute('data-target');
        const roomList = document.getElementById(targetId);

        if (e.target.checked) {
          const res = await fetch(`/api/faculty/${targetId}`);
          const rooms = await res.json();

          roomList.innerHTML = `
            <ul>
              ${rooms.map(room => `
                <li class="room-click" data-lat="${room.lat}" data-lng="${room.lng}">
                  <i class="material-icons" style="color: #ca1212;">place</i> ${room.name}
                </li>
              `).join('')}
            </ul>
          `;

          // Redirect map to location on click
          roomList.querySelectorAll('.room-click').forEach(roomItem => {
            roomItem.addEventListener('click', () => {
              const lat = parseFloat(roomItem.dataset.lat);
              const lng = parseFloat(roomItem.dataset.lng);
              if (window.map) {
                window.map.panTo({ lat: lat, lng: lng });
                window.map.setZoom(18);
              }
            });
          });

        } else {
          roomList.innerHTML = '';
        }
      });
    });

    // Search filter logic
    const searchInput = document.getElementById('search');
    const facultyItems = document.querySelectorAll('.faculty-item');

    searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase().trim();

      facultyItems.forEach(item => {
        const labelText = item.innerText.toLowerCase();
        item.style.display = labelText.includes(query) ? 'block' : 'none';
      });
    });
  });
</script>
{% endblock %}